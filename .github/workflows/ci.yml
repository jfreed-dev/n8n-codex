name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: claude-agent

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: claude-agent/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff mypy

      - name: Lint with ruff
        run: ruff check src/

      - name: Type check with mypy
        run: mypy src/ --ignore-missing-imports

  test:
    name: Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: claude-agent

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: claude-agent/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Run tests
        run: pytest tests/ -v

  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build claude-agent image
        uses: docker/build-push-action@v5
        with:
          context: ./claude-agent
          push: false
          tags: claude-agent:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  validate-compose:
    name: Validate Docker Compose
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Validate docker-compose.yml
        run: docker compose config --quiet

  validate-workflows:
    name: Validate n8n Workflows
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Validate workflow JSON files
        run: |
          for f in workflows/*.json; do
            echo "Validating $f..."
            python -m json.tool "$f" > /dev/null
          done
